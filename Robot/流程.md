菌包很大，所以直接做一个实例分割，然后求mask的对应的点云均值即可
1.先用yolov8-seg分割出每个菌包mask
2.提取mask每个像素对应的点云，求均值作为抓包的xyz
3.做前后排序，先抓前面的后抓后面的
4.发送给控制



### **一、初始化与全局配置**
#### 1. 依赖与常量定义
- 导入核心库：多进程（`multiprocessing`）、多线程（`threading`）、OpenCV（`cv2`）、numpy、YOLO分割模型（`Yolov8Seg`）、Realsense相机（`D415`）、串口通信（`Serial`）、日志工具（`Logger`）等。
- 定义路径：`modelpath`（模型存放路径）、`savepath`（结果保存路径）。
- 进程间通信队列：`Transmit1/2`（向机械臂发送数据）、`Recept1/2`（接收机械臂命令），队列长度为1（确保数据实时性）。
- 线程同步锁：`lock`（保证串口写操作的线程安全）。


### **二、核心功能模块**
#### 1. 串口通信模块（多线程）
串口操作通过独立进程（`Serial_Op`）实现，内部包含3个线程：1个读线程（`Serial_read`）和2个写线程（`Serial_Write`），分别对应两个机械臂的通信。

- **`Serial_read` 线程**：
  - 功能：持续从串口读取命令（最多100字节），进行CRC校验（确保数据完整性）。
  - 命令解析：校验通过后，从命令中提取`value`（机械臂编号）：
    - `value=1`：将命令放入`Recept1`队列（对应机械臂1）。
    - `value=3`：执行关机命令（`shutdown /s /t 1`）。
  - 异常处理：读取失败时设置`stop_event`，终止线程并触发重试。


- **`Serial_Write` 线程**：
  - 功能：从`Transmit`队列中获取数据，通过串口发送给机械臂。
  - 数据处理：
    - 若数据长度为1（如`[1]`）：表示机械臂1无目标，调用`push_other_inform`发送状态。
    - 若数据长度>1（如`[1, x, y, z]`）：表示机械臂1有目标，调用`push_right_axis2`发送三维坐标。
  - 线程安全：通过`lock`确保多线程写串口时的数据一致性。


- **`Serial_Op` 进程**：
  - 功能：管理串口通信的生命周期，负责串口初始化、线程启停和异常重试。
  - 流程：
    1. 初始化`stop_event`（用于线程终止信号）。
    2. 循环尝试连接串口（`COM1`，波特率115200），连接成功后启动`Serial_read`和两个`Serial_Write`线程。
    3. 若串口异常（如断开），设置`stop_event`终止线程，延迟1秒后重试连接。
    4. 最终关闭串口释放资源。


#### 2. 视觉检测与坐标计算模块（`consumer` 进程）
该进程对应单个机械臂（如`arm=1`），负责相机数据采集、目标检测、三维坐标计算，并将结果通过`Transmit`队列发送给串口模块。

- **初始化**：
  - 日志配置：将输出重定向到`savepath`下的日志文件（按时间命名，如`2023_10_01_12_00_00_arm1.txt`）。
  - 相机与模型：初始化Realsense D415相机（分辨率640×480）、YOLOv8分割模型（`zhuabaoseg.onnx`，用于检测蘑菇菌包）。
  - 可视化：若`showpic=1`，创建显示窗口（`image1`）用于实时展示图像。


- **主循环（检测流程）**：
  1. **等待命令**：循环检测`Recept`队列（如`Recept1`），收到机械臂命令后开始处理（命令格式为`[value, armx, army]`）。
  2. **图像采集**：通过`d415.get_d415_img()`获取相机彩色图像（代码中临时用示例图片`srcimg0`替代，实际应采集实时图像）。
  3. **可视化画布**：若启用显示，创建2×2网格画布，左上显示原始图像，右上显示彩色深度图。
  4. **目标检测**：调用`detectnet1.detect(srcimg)`得到目标框（`boxs`）、标签（`labels`）、置信度（`confs`）和分割掩码（`masks`）。
  5. **无目标处理**：若未检测到目标，通过`Transmit`队列发送`[arm]`（如`[1]`），通知机械臂无目标，并清空`Recept`队列等待下一次命令。
  6. **有目标处理**：
     - 绘制检测结果：在左下画布绘制带掩码的目标框。
     - 三维坐标计算：调用`d415.get_world_axis(box, masks)`将图像坐标转换为三维世界坐标（格式：`[left, top, right, bottom, cx, cy, x, y, z, 0, size]`，其中`x,y,z`为三维坐标）。
     - 坐标筛选：仅保留有效三维坐标的目标，按距离（`z`轴）从近到远排序，取最近的1个目标。
     - 发送坐标：将目标三维坐标（放大1000倍转为整数）通过`Transmit`队列发送（格式：`[arm, x*1e3, y*1e3, z*1e3]`）。
  7. **退出逻辑**：按`q`或`ESC`键关闭显示窗口，退出循环。


- **异常处理**：
  - 相机异常时打印错误信息，延迟1秒后重试连接。
  - 最终通过`d415.stop()`释放相机资源。


### **三、主程序流程（`if __name__ == '__main__'`）**
1. 启用多进程支持（`multiprocessing.freeze_support()`，用于Windows环境打包）。
2. 配置参数：`showpic=1`（启用可视化），读取`modelpath/caid.txt`（可能为设备ID配置）。
3. 启动进程：
   - 串口进程：`Serial_Op`（处理串口读写）。
   - 检测进程：`consumer`（对应机械臂1，参数为`caid[0], 1, Recept1, Transmit1, showpic`）。
4. 进程管理：设置进程为守护进程（主程序退出时自动终止），启动并等待所有进程结束。


### **四、数据流向与系统交互**
1. **命令流**：机械臂 → 串口 → `Serial_read`线程 → `Recept1/2`队列 → `consumer`进程（触发检测）。
2. **结果流**：`consumer`进程（计算坐标） → `Transmit1/2`队列 → `Serial_Write`线程 → 串口 → 机械臂。
3. **多进程/线程协作**：通过`Queue`实现进程间通信，通过`Event`和`Lock`实现线程同步与终止。


### **总结**
该系统是一个典型的“感知-决策-执行”闭环系统：
- **感知**：Realsense相机采集图像，YOLOv8模型检测目标并分割轮廓。
- **决策**：计算目标三维坐标，筛选最近目标作为抓取点。
- **执行**：通过串口将坐标发送给机械臂，完成抓取控制。

系统设计考虑了实时性（短队列、多线程）和鲁棒性（异常重试、资源释放），可扩展支持多机械臂协同工作（通过`Recept2/Transmit2`扩展）。